<!DOCTYPE html>
<html lang="fi">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<head>
<link href="2048.css" rel="stylesheet">
<title>yhet sauhut vielä</title>
<meta name="description" content="2048 peli, yhet vielä, yhet sauhut vielä, 2048 rööki, niksat, juhannuskukkula, projekti">
<link rel="icon" type="image/x-icon"  href="kuvat/2048-icon.png" >
</head>

<body>
  <div class="game">
    <div class="head">
      <div class="header"><h1>Yhet sauhut vielä</h1></div>
      <div class="a"><button class="info" onClick='info()'>i</button><button id="repeat" class="info repeat" onClick='reset()'>↻</button></div>
      <div class="score">Pisteet:<br/><span id="value">0</span></div>
      <div class="highscore">Ennätys:<br/><span id="highscore">0</span></div>
    </div>

    <div class="field">
      
      <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
      </div>
      <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
      </div>
      <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
      </div>
      <div class="row">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
      </div>
      <div>
        <button class="katkaisuhoito" onclick="katkaisuhoito()">Katkaisuhoito</button>
      </div>
    </div>
  </div>
  <div class='' id='status'>
  </div>
<script>
  let newScore = 0;

window.onload = function() {
    buildGridOverlay();                      
    cellCreator(2, 0);
    score();
    let tallennaHigh = localStorage.getItem("high-score") || 0;
    document.getElementById("highscore").innerText = tallennaHigh;
};

function getTileImage(value) {
    switch(value) {
      case 2: return "kuvat/chesterfield.jpg";
      case 4: return "kuvat/winston.jpg";
      case 8: return "kuvat/luckystrike.jpg";
      case 16: return "kuvat/L&M.png";
      case 32: return "kuvat/Pall-Mall-blue.jpg";
      case 64: return "kuvat/pallmallred.png";
      case 128: return "kuvat/mallun-kultane.webp";
      case 256: return "kuvat/cameli.png";
      case 512: return "kuvat/mallun-punanen.jpg";
      case 1024: return "kuvat/kuubalainen.jpg";
      case 2048: return "kuvat/piippu.jpg";
      default: return "images/default.png"; 
    }
}

function buildGridOverlay() {
    var size = 4;
    var table = document.createElement('DIV');
    table.className += 'grid';
    table.id = ' ';
    table.dataset.value = 0;
    
    for (var i = 0; i < size; i++) {
      var tr = document.createElement('DIV');
      table.appendChild(tr);
      tr.id = 'row_' + (i+1);
      tr.className += 'grid_row';
      
      for (var j = 0; j < size; j++) {
        var td = document.createElement('DIV');
        td.id = '' +(i+1) +(j+1);                     
        td.className += 'grid_cell';
        tr.appendChild(td);
      }
      document.body.appendChild(table);
    }
    return table;
}

function cellCreator(c, timeOut) {
    for (var i = 0; i < c; i++) {
      for (var value = 1; value < 2; value++) {
        var randomX = Math.floor((Math.random()*4)+1);
        var randomY = Math.floor((Math.random()*4)+1);
        var checker = document.getElementById('' +randomX +randomY);
        if (checker.innerHTML != '') {
          value = 0;
        } 
      }
      
      var randomValue = Math.floor((Math.random()*4) +1); 
      if (randomValue == 3) {randomValue=4};
      if (randomValue == 1) {randomValue=2};
      var position = document.getElementById(''+randomX +randomY);
      var tile = document.createElement('DIV');           
      position.appendChild(tile);                         
      tile.innerHTML = `<img src="${getTileImage(randomValue)}" alt="${randomValue}">`;
      
      tile.data = ''+randomValue;
      tile.id = 'tile_'+randomX +randomY;
      position.className += ' active';
      tile.dataset.value = ''+randomValue;
      
      if (timeOut == 0) {
        tile.className = 'tile '+randomValue;
      } else { 
        setTimeout(function() {
          tile.className = 'tile '+randomValue;
        }, 10); 
      }
    }
}

document.onkeydown = directions;

function directions(e) {
    e = e || window.event;
    var d = 0;
    if (e.keyCode == '38') {   
      var count = 2;  
      for (var x = 2; x > 1; x--) {
        for (var y = 1; y < 5; y++) {
          moveTilesMain(x, y, -1, 0, 1, 0);
        }
        if (x == 2) { x += count; count++; }
        if (count > 4) { break; }
      }
      cellReset();
    }   
    else if (e.keyCode == '40') { 
      var count = -2;  
      for (var x = 3; x < 4; x++) {
        for (var y = 1; y < 5; y++) {
          moveTilesMain(x, y, 1, 0, 4, 0);
        }
        if (x == 3) { x += count; count--; }
        if (count < -4) { break; }
      }
      cellReset();
    }
    else if (e.keyCode == '37') { 
      var count = 2;  
      for (var x = 2; x > 1; x--) {
        for (var y = 1; y < 5; y++) {
          moveTilesMain(y, x, 0, -1, 0, 1);
        }
        if (x == 2) { x += count; count++; }
        if (count > 4) { break; }
      }
      cellReset();
    }
    else if (e.keyCode == '39') { 
      var count = -2;  
      for (var x = 3; x < 4; x++) {
        for (var y = 1; y < 5; y++) {
          moveTilesMain(y, x, 0, 1, 0, 4);
        }
        if (x == 3) { x += count; count--; }
        if (count < -4) { break; }
      }
      cellReset();
    }
}

function moveTilesMain(x, y, X, Y, xBorder, yBorder) {      
    var tile     = document.getElementById('tile_'+x +y);
    var checker  = document.getElementById(''+x +y);
    var xAround  = x+X;
    var yAround  = y+Y;
    
    if (xAround > 0 && xAround < 5 && yAround > 0 && yAround < 5 && checker.className == 'grid_cell active') {
      var around = document.getElementById(''+xAround +yAround);
      if (around.className == 'grid_cell active') {
        var aroundTile = document.getElementById('tile_'+xAround +yAround);
        if (aroundTile.dataset.value == tile.dataset.value) {
          var value = parseInt(tile.dataset.value) * 2;
          aroundTile.dataset.value = ''+value;
          aroundTile.className = 'tile '+value;
          aroundTile.innerHTML = `<img src="${getTileImage(value)}" alt="${value}">`;
          checker.removeChild(tile);
          checker.className = 'grid_cell';
          around.className  = 'grid_cell active merged';
          var grid = document.getElementById(' ');
          var scoreValue = parseInt(grid.dataset.value);
          newScore = value + scoreValue;
          grid.dataset.value = newScore;
          score();
        } 
      } else if (around.className == 'grid_cell'){
        around.appendChild(tile);
        around.className = 'grid_cell active';
        tile.id = 'tile_'+xAround +yAround;
        checker.className = 'grid_cell';
      }
    }  
}

function cellReset() {
    var count = 0;
    for (var x=1; x<5; x++) {
      for (var y=1; y<5; y++) {
        var resetter = document.getElementById(''+x +y);
        if (resetter.innerHTML != '') { count++; }
        if (resetter.innerHTML == '') { resetter.className = 'grid_cell'; }
        if (resetter.className == 'grid_cell active merged') {
          resetter.className = 'grid_cell active'
        }
      }
    }
    if (count == 16) {
      document.getElementById('status').className = 'lose';
    } else { 
      cellCreator(1, 1); 
    }
}

function katkaisuhoito() {
    if (document.getElementById('status').classList.contains('lose')) {
        document.getElementById('status').innerText = "Peli on jo hävitty!";
        setTimeout(() => {
            document.getElementById('status').innerText = "";
        }, 2000);
        return;
    }
    
    if (newScore < 1000) {
        document.getElementById('status').innerText = "Tarvitset vähintään 1000 pistettä!";
        setTimeout(() => {
            document.getElementById('status').innerText = "";
        }, 2000);
        return;
    }

    newScore -= 1000;
    document.getElementById(' ').dataset.value = newScore;
    document.getElementById('value').innerHTML = newScore;

    let tilesDeleted = false;
    for (let x = 1; x <= 4; x++) {
        for (let y = 1; y <= 4; y++) {
            let cell = document.getElementById('' + x + y);
            if (cell.className === 'grid_cell active') {
                let tile = document.getElementById('tile_' + x + y);
                let value = parseInt(tile.dataset.value);
                if (value < 64) {
                    cell.removeChild(tile);
                    cell.className = 'grid_cell'; 
                    tilesDeleted = true;
                }
            }
        }
    }

    if (tilesDeleted) {
        document.getElementById('status').innerText = "Kaikki alle 64 poistettu! (-1000 pistettä)";
        setTimeout(() => {
            document.getElementById('status').innerText = "";
        }, 2000);
    } else {
        document.getElementById('status').innerText = "Ei poistettavia tiiliä! (-1000 pistettä)";
        setTimeout(() => {
            document.getElementById('status').innerText = "";
        }, 2000);
    }
}

function score() {
    var grid = document.getElementById(' ');
    var value = grid.dataset.value;
    document.getElementById('value').innerHTML = ''+value;
    newScore = parseInt(value);
    updateHighScore();
}

function updateHighScore() {
    let currentHighScore = parseInt(localStorage.getItem("high-score") || 0);
    if (newScore > currentHighScore) {
        localStorage.setItem("high-score", newScore);
        document.getElementById("highscore").innerText = newScore;
    }
}

function info() {
    setTimeout(function() {
      document.getElementById('description').classList.toggle('show');
    }, 10);  
}

function reset() {
    for (var x = 1; x < 5; x++) {
      for (var y = 1; y < 5; y++) {
        var resetter = document.getElementById(''+x +y);
        if (resetter.className == 'grid_cell active') {
          var tile = document.getElementById('tile_'+x +y);
          resetter.removeChild(tile);
        }
      }
    }
    document.getElementById('status').className = '';
    document.getElementById(' ').dataset.value = 0;
    newScore = 0;
    score();
    let savedHighScore = localStorage.getItem("high-score") || 0;
    document.getElementById("highscore").innerText = savedHighScore;
    cellReset();
    cellCreator(2, 0);
}
</script>
</body>
</html>